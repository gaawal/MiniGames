<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯»åæ¢æº - ä¸­æ–‡åå­—ç”Ÿæˆå™¨</title>
  <!-- å¼•å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å¼•å…¥ Inter å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fc;
    }
    .container-card {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .trait-checkbox:checked + .trait-label {
      background-color: #3b82f6; /* Blue 500 */
      color: white;
      border-color: #3b82f6;
    }
    /* Custom scrollbar for mobile */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 10px;
    }
  </style>
</head>
<body class="min-h-screen p-4 sm:p-6 flex items-center justify-center">

<div class="w-full max-w-4xl bg-white rounded-xl p-6 md:p-10 container-card">

  <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">å¯»åæ¢æº</h1>
  <p class="text-center text-gray-500 mb-8">æ ¹æ®æ‚¨çš„åå¥½ï¼ŒAI æ™ºèƒ½ç”Ÿæˆä¸­æ–‡åå­—</p>

  <!-- è¾“å…¥è¡¨å•åŒºåŸŸ -->
  <div id="input-form" class="space-y-6">

    <!-- 1. å§“æ°è¾“å…¥ -->
    <div>
      <label for="surname" class="block text-sm font-medium text-gray-700 mb-1">æ‚¨çš„å§“æ° (å¿…å¡«)</label>
      <input type="text" id="surname" placeholder="ä¾‹å¦‚ï¼šæ" value="æ"
             class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg font-semibold text-center uppercase tracking-widest">
    </div>

    <!-- 2. åå­—é•¿åº¦ -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">åå­—é•¿åº¦</label>
      <div class="flex space-x-4">
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="name-length" value="ä¸¤å­—å (å•å)" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
          <span class="ml-2 text-gray-700">ä¸¤å­—å (å•å)</span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="name-length" value="ä¸‰å­—å (åŒå)" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
          <span class="ml-2 text-gray-700">ä¸‰å­—å (åŒå)</span>
        </label>
      </div>
    </div>

    <!-- 3. æ€§åˆ«åå¥½ -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">æ€§åˆ«åå¥½</label>
      <div class="flex space-x-4">
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="gender-preference" value="ç”·æ€§ (é˜³åˆšã€å¤§æ°”)" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
          <span class="ml-2 text-gray-700">ç”·æ€§</span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="gender-preference" value="å¥³æ€§ (æŸ”ç¾ã€å…¸é›…)" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
          <span class="ml-2 text-gray-700">å¥³æ€§</span>
        </label>
        <label class="flex items-center cursor-pointer">
          <input type="radio" name="gender-preference" value="ä¸­æ€§ (ä¸­æ­£ã€å¹³å’Œ)" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
          <span class="ml-2 text-gray-700">ä¸­æ€§</span>
        </label>
      </div>
    </div>

    <!-- 4. æœŸæœ›æ€§æ ¼/å¯“æ„ -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">æœŸæœ›æ€§æ ¼/å¯“æ„ (å¯å¤šé€‰)</label>
      <div id="trait-options" class="flex flex-wrap gap-2">
        <!-- Checkboxes will be populated by JS -->
      </div>
    </div>

    <!-- 5. è¡¥å……è¦æ±‚ (ä¾‹å¦‚äº”è¡Œã€è¾ˆåˆ†ã€æ’é™¤è¯) -->
    <div>
      <label for="additional-requirements" class="block text-sm font-medium text-gray-700 mb-1">è¡¥å……è¦æ±‚ (ä¾‹å¦‚ï¼šäº”è¡Œç¼ºæ°´ï¼Œéœ€ç”¨æœ¨å­—æ—çš„å­—ï¼Œæˆ–æ’é™¤çš„å­—)</label>
      <textarea id="additional-requirements" rows="2" placeholder="ä¾‹å¦‚ï¼šåå­—ä¸­æœ€å¥½åŒ…å«â€˜æœ¨â€™å±æ€§çš„å­—ï¼›è¯·é¿å…ä½¿ç”¨â€˜ä¼Ÿâ€™å­—ã€‚"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
    </div>

    <!-- ç”ŸæˆæŒ‰é’® -->
    <button id="generate-button" onclick="handleGenerateName()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
      ğŸš€ æ™ºèƒ½ç”Ÿæˆåå­—
    </button>
    <div id="error-message" class="text-red-500 text-center mt-3 hidden p-2 bg-red-100 rounded-lg"></div>
  </div>

  <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
  <div id="results-container" class="mt-10 hidden">
    <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-2">æ¨èåå­—åˆ—è¡¨</h2>
    <div id="name-results" class="space-y-4">
      <!-- Name cards will be inserted here -->
    </div>
    <button onclick="handleGenerateName(true)"
            class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-xl transition duration-150 ease-in-out">
      ğŸ”„ é‡æ–°ç”Ÿæˆ (è·å–æ›´å¤šé€‰æ‹©)
    </button>
  </div>

  <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
  <div id="loading-spinner" class="mt-10 text-center hidden">
    <div class="flex items-center justify-center space-x-2">
      <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="text-lg text-blue-600 font-medium">AI æ­£åœ¨ä¸ºæ‚¨ç²¾å¿ƒæŒ‘é€‰åå­—...</span>
    </div>
    <p class="text-sm text-gray-500 mt-2">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚</p>
  </div>

</div>

<script>
  // --- API Configuration and Utility Functions ---

  const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
  const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
  const API_KEY = ""; // Canvas will automatically provide the API key at runtime

  /**
   * Converts the traits object into HTML checkboxes and inserts them into the DOM.
   */
  function populateTraits() {
    const traits = [
      { label: "æ™ºæ…§", value: "æ™ºæ…§, èªæ˜, ç¿æ™º" },
      { label: "æ²‰ç¨³", value: "æ²‰ç¨³, å†…æ•›, å†…æ¶µ" },
      { label: "å¼€æœ—", value: "å¼€æœ—, ä¹è§‚, æ´»æ³¼" },
      { label: "è´¢å¯Œ", value: "è´¢å¯Œ, å¯Œè¶³, ç¹è£" },
      { label: "å¥åº·", value: "å¥åº·, é•¿å¯¿, å®‰åº·" },
      { label: "å‹‡æ°”", value: "å‹‡æ°”, åšæ¯…, å‹‡æ•¢" },
      { label: "ä¼˜é›…", value: "ä¼˜é›…, æ°”è´¨, æŸ”ç¾" },
      { label: "è¯šä¿¡", value: "è¯šä¿¡, å–„è‰¯, å“å¾·" },
      { label: "å…‰æ˜", value: "å…‰æ˜, å¸Œæœ›, å‰é€”" },
      { label: "åˆ›æ–°", value: "åˆ›æ–°, ç‹¬ç‰¹, æ–°é¢–" }
    ];

    const container = document.getElementById('trait-options');
    traits.forEach((trait, index) => {
      const isChecked = index < 3; // Default select the first three for easier testing

      container.innerHTML += `
                    <input type="checkbox" id="trait-${index}" value="${trait.value}" class="hidden trait-checkbox" ${isChecked ? 'checked' : ''}>
                    <label for="trait-${index}" class="trait-label px-3 py-1 text-sm font-medium border border-gray-300 rounded-full cursor-pointer select-none transition duration-150 ease-in-out hover:bg-gray-100 ${isChecked ? 'bg-blue-500 text-white' : 'text-gray-700 bg-white'}">
                        ${trait.label}
                    </label>
                `;
    });

    // Reattach event listeners for dynamic styling
    document.querySelectorAll('.trait-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const label = e.target.nextElementSibling;
        if (e.target.checked) {
          label.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
          label.classList.add('bg-blue-500', 'text-white');
        } else {
          label.classList.remove('bg-blue-500', 'text-white');
          label.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
        }
      });
    });
  }

  /**
   * Handles the click event for name generation.
   * @param {boolean} isRetry - Whether this is a retry/refresh call.
   */
  async function handleGenerateName(isRetry = false) {
    const surname = document.getElementById('surname').value.trim();
    const length = document.querySelector('input[name="name-length"]:checked').value;
    const gender = document.querySelector('input[name="gender-preference"]:checked').value;
    const additional = document.getElementById('additional-requirements').value.trim();

    if (!surname) {
      displayError("è¯·è¾“å…¥æ‚¨çš„å§“æ°ï¼");
      return;
    }

    const selectedTraits = Array.from(document.querySelectorAll('.trait-checkbox:checked'))
            .map(cb => cb.value)
            .join(', ');

    const traitString = selectedTraits ? `åå­—åº”åŒ…å«ä»¥ä¸‹å¯“æ„å’Œæ€§æ ¼ç‰¹å¾ï¼š${selectedTraits}ã€‚` : 'åå­—åº”ç§¯æã€ç¾å¥½ã€å¯“æ„æ·±è¿œã€‚';

    // Construct the main user query
    const userQuery = `è¯·ä¸ºæˆ‘ç”Ÿæˆ 5 ä¸ªä¸­æ–‡åå­—ã€‚æˆ‘çš„å§“æ°æ˜¯ "${surname}"ã€‚åå­—é•¿åº¦è¦æ±‚æ˜¯ ${length}ã€‚æ€§åˆ«åå¥½æ˜¯ ${gender}ã€‚${traitString}ã€‚ä»¥ä¸‹æ˜¯é¢å¤–çš„è¦æ±‚æˆ–æ’é™¤é¡¹ï¼ˆå¦‚æ— åˆ™å¿½ç•¥ï¼‰ï¼š${additional || 'æ— '}`;

    const systemPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¸­æ–‡å§“åå­¦ä¸“å®¶å’Œèµ·åå¤§å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„å§“æ°ã€é•¿åº¦å’Œåå¥½ï¼Œç”Ÿæˆ 5 ä¸ªç‹¬ç‰¹ã€å¯“æ„å‰åˆ©ã€éŸ³å¾‹å’Œè°çš„ä¸­æ–‡åå­—ã€‚ç”Ÿæˆç»“æœå¿…é¡»ä¸¥æ ¼éµå¾ªæä¾›çš„ JSON Schema æ ¼å¼ã€‚æ¯ä¸ªåå­—éƒ½éœ€è¦åŒ…å«ç”¨æˆ·æä¾›çš„å§“æ°ã€‚";

    // Structured JSON Schema for the 'API' response
    const responseSchema = {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          "name": { "type": "STRING", description: "The complete generated Chinese name including the surname, e.g., æå­æ¶µ." },
          "meaning": { "type": "STRING", description: "A concise summary of the name's auspicious meaning, e.g., æ„æŒ‡æ™ºæ…§ã€æ²‰ç¨³ã€å¿ƒèƒ¸å®½å¹¿." },
          "analysis": { "type": "STRING", description: "A detailed analysis covering character traits, sound harmony, and gender suitability, e.g., å“²å­—æ˜¾æ™ºæ…§ï¼Œæ¶µå­—æ˜¾å†…æ¶µä¸æ°´å±æ€§ï¼Œæ•´ä½“éŸ³å¾‹å’Œè°ï¼Œå¤§æ°”." }
        },
        required: ["name", "meaning", "analysis"]
      }
    };

    // Hide previous results/error, show loading
    document.getElementById('results-container').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');
    document.getElementById('loading-spinner').classList.remove('hidden');
    document.getElementById('generate-button').disabled = true;

    try {
      const responseJson = await callGeminiAPI(userQuery, systemPrompt, responseSchema);
      renderResults(responseJson);
    } catch (error) {
      console.error("Name generation failed:", error);
      displayError("åå­—ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚");
    } finally {
      // Hide loading, enable button
      document.getElementById('loading-spinner').classList.add('hidden');
      document.getElementById('generate-button').disabled = false;
    }
  }

  /**
   * Calls the Gemini API with structured output configuration.
   * Implements exponential backoff for robustness.
   * @param {string} userQuery - The main prompt from the user inputs.
   * @param {string} systemPrompt - The system instruction for the model.
   * @param {object} schema - The required JSON schema.
   * @returns {Promise<Array>} The parsed JSON response from the model.
   */
  async function callGeminiAPI(userQuery, systemPrompt, schema) {
    const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: { parts: [{ text: systemPrompt }] },
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: schema
      }
    };

    const maxRetries = 5;
    for (let attempt = 0; attempt < maxRetries; attempt++) {
      const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s, 8s, 16s

      try {
        const response = await fetch(`${API_BASE_URL}?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.status === 429 && attempt < maxRetries - 1) {
          // Too many requests, wait and retry (handled silently by the loop)
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }

        if (!response.ok) {
          const errorBody = await response.text();
          throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
        }

        const result = await response.json();

        if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {

          const jsonText = result.candidates[0].content.parts[0].text;
          return JSON.parse(jsonText);

        } else {
          throw new Error("Invalid response structure from API.");
        }

      } catch (error) {
        if (attempt === maxRetries - 1) {
          throw error;
        }
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  /**
   * Renders the name results onto the page.
   * @param {Array<Object>} names - The array of generated name objects.
   */
  function renderResults(names) {
    const resultsContainer = document.getElementById('name-results');
    resultsContainer.innerHTML = ''; // Clear previous results

    if (!names || names.length === 0) {
      displayError("æœªèƒ½ç”Ÿæˆä»»ä½•ç¬¦åˆæ¡ä»¶çš„åå­—ï¼Œè¯·å°è¯•è°ƒæ•´æ‚¨çš„åå¥½è®¾ç½®ã€‚");
      return;
    }

    names.forEach((item, index) => {
      const nameCard = `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border-l-4 border-blue-600 shadow-md">
                        <div class="flex items-center mb-3">
                            <span class="text-3xl font-extrabold text-blue-800">${index + 1}. ${item.name}</span>
                            <span class="ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-blue-200 text-blue-800">${item.name.length === 3 ? 'ä¸‰å­—å (åŒå)' : 'ä¸¤å­—å (å•å)'}</span>
                        </div>

                        <div class="space-y-2">
                            <p class="text-gray-700">
                                <span class="font-bold text-gray-900">æ ¸å¿ƒå¯“æ„:</span> ${item.meaning}
                            </p>
                            <p class="text-sm text-gray-600 border-t pt-2 mt-2">
                                <span class="font-bold text-gray-900">ä¸“å®¶åˆ†æ:</span> ${item.analysis}
                            </p>
                        </div>
                    </div>
                `;
      resultsContainer.innerHTML += nameCard;
    });

    document.getElementById('results-container').classList.remove('hidden');
  }

  /**
   * Displays an error message on the page.
   * @param {string} message - The error message to display.
   */
  function displayError(message) {
    const errorElement = document.getElementById('error-message');
    errorElement.textContent = message;
    errorElement.classList.remove('hidden');
  }

  // Initialize the trait options on load
  populateTraits();
</script>
</body>
</html>
